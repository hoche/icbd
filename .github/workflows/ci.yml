name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ---------------------------------------------------------------
  # Native Linux and macOS builds using GitHub-hosted runners
  # ---------------------------------------------------------------
  build-native:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ---- Linux x64 ----
          - os: ubuntu-24.04
            name: Linux (Ubuntu 24.04 x64)
          - os: ubuntu-22.04
            name: Linux (Ubuntu 22.04 x64)

          # ---- Linux ARM64 ----
          # Note: ARM runners are free for public repos.
          # If your repo is private, these may require a paid plan.
          - os: ubuntu-24.04-arm
            name: Linux (Ubuntu 24.04 ARM64)
          - os: ubuntu-22.04-arm
            name: Linux (Ubuntu 22.04 ARM64)

          # ---- macOS Apple Silicon (ARM64) ----
          - os: macos-15
            name: macOS 15 (Apple Silicon)
          - os: macos-14
            name: macOS 14 (Apple Silicon)

          # ---- macOS Intel (x64) ----
          - os: macos-15-intel
            name: macOS 15 (Intel x64)

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdbm-dev cmake python3

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gdbm cmake python3 || true

      - name: Configure (Linux)
        if: runner.os == 'Linux'
        run: cmake -S . -B build -DADMIN_PWD=ci_test_pwd

      - name: Configure (macOS)
        if: runner.os == 'macOS'
        run: |
          HOMEBREW_PREFIX="$(brew --prefix)"
          GDBM_PREFIX="$(brew --prefix gdbm)"
          cmake -S . -B build \
            -DADMIN_PWD=ci_test_pwd \
            -DCMAKE_PREFIX_PATH="$HOMEBREW_PREFIX" \
            -DCMAKE_INCLUDE_PATH="$GDBM_PREFIX/include" \
            -DCMAKE_LIBRARY_PATH="$GDBM_PREFIX/lib"

      - name: Build
        run: cmake --build build

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure

  # ---------------------------------------------------------------
  # FreeBSD builds using cross-platform-actions (runs a FreeBSD VM
  # on an Ubuntu host runner via QEMU)
  # ---------------------------------------------------------------
  build-freebsd:
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "14.1"
            name: FreeBSD 14.1
          - version: "14.0"
            name: FreeBSD 14.0
          - version: "13.3"
            name: FreeBSD 13.3

    name: ${{ matrix.name }}
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & test in FreeBSD VM
        uses: cross-platform-actions/action@v0.25.0
        with:
          operating_system: freebsd
          version: ${{ matrix.version }}
          run: |
            sudo pkg install -y cmake gdbm python3
            cmake -S . -B build -DADMIN_PWD=ci_test_pwd
            cmake --build build
            cd build && ctest --output-on-failure
